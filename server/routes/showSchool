const express = require('express');
const mysql = require('mysql2/promise');
const router = express.Router();

// Database configuration
const dbConfig = {
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'your_username',
  password: process.env.DB_PASSWORD || 'your_password',
  database: process.env.DB_NAME || 'school_management'
};

// GET route to fetch all schools
router.get('/', async (req, res) => {
  let connection;
  
  try {
    connection = await mysql.createConnection(dbConfig);
    
    const selectQuery = `
      SELECT 
        id,
        name,
        address,
        city,
        state,
        contact,
        email_id,
        image_path as image,
        created_at,
        updated_at
      FROM schools 
      ORDER BY created_at DESC
    `;
    
    const [rows] = await connection.execute(selectQuery);
    
    console.log(`Found ${rows.length} schools`);
    
    res.status(200).json({
      success: true,
      message: `Found ${rows.length} schools`,
      schools: rows,
      total: rows.length
    });

  } catch (error) {
    console.error('Error fetching schools:', error);
    
    // Handle specific database errors
    if (error.code === 'ER_NO_SUCH_TABLE') {
      return res.status(404).json({
        error: 'Schools table does not exist. Please add a school first.',
        success: false,
        schools: []
      });
    }
    
    if (error.code === 'ER_ACCESS_DENIED_ERROR') {
      return res.status(500).json({
        error: 'Database access denied. Please check your credentials.',
        success: false,
        schools: []
      });
    }
    
    res.status(500).json({
      error: 'Failed to fetch schools. Please try again later.',
      success: false,
      schools: []
    });

  } finally {
    if (connection) {
      await connection.end();
    }
  }
});

// GET route to fetch a single school by ID
router.get('/:id', async (req, res) => {
  let connection;
  const { id } = req.params;
  
  try {
    connection = await mysql.createConnection(dbConfig);
    
    const selectQuery = `
      SELECT 
        id,
        name,
        address,
        city,
        state,
        contact,
        email_id,
        image_path as image,
        created_at,
        updated_at
      FROM schools 
      WHERE id = ?
    `;
    
    const [rows] = await connection.execute(selectQuery, [id]);
    
    if (rows.length === 0) {
      return res.status(404).json({
        error: 'School not found',
        success: false
      });
    }
    
    res.status(200).json({
      success: true,
      message: 'School found successfully',
      school: rows[0]
    });

  } catch (error) {
    console.error('Error fetching school:', error);
    
    res.status(500).json({
      error: 'Failed to fetch school details',
      success: false
    });

  } finally {
    if (connection) {
      await connection.end();
    }
  }
});

module.exports = router;